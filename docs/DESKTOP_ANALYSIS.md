# PixelPunk 图床桌面端功能分析文档

> 文档创建时间：2025-10-05
> 版本：v1.0
> 作者：Claude Code

## 📋 目录

- [项目背景](#项目背景)
- [Web端功能分析](#web端功能分析)
- [桌面端核心优势](#桌面端核心优势)
- [差异化功能设计](#差异化功能设计)
- [技术实现方案](#技术实现方案)
- [开发路线图](#开发路线图)

---

## 项目背景

### 项目简介

**PixelPunk** 是一个赛博朋克风格的新一代 AI 图床系统，包含以下特性：

- **后端技术栈**：Go + Gin + MySQL + Redis
- **Web前端**：Vue 3 + TypeScript + TailwindCSS
- **桌面端**：Tauri 2 + Vue 3 + TypeScript

### 现有架构

- 后端和 Web 端已完成开发，功能完善
- 桌面端基础架构已搭建完成（多窗口、认证系统、配置系统）
- 桌面端已对接登录系统
- 共用后端 API 接口

---

## Web端功能分析

### 核心功能模块

#### 1. 用户系统

- 用户注册/登录
- 个人资料管理
- 存储空间统计
- API Key 管理

#### 2. 文件管理

- **上传功能**
  - 单文件/批量上传
  - 拖拽上传
  - 分块上传（大文件）
  - 上传进度显示
- **访问控制**
  - Public：公开访问
  - Private：私有访问
  - Protected：受保护访问
- **文件组织**
  - 文件夹管理（支持层级）
  - 标签系统
  - 分类管理
- **文件操作**
  - 查看、编辑、删除
  - 批量操作
  - 移动/复制
  - 下载

#### 3. AI 智能功能

- **智能标签**
  - 自动识别图片内容
  - 自动打标签
- **向量搜索**
  - 基于 Qdrant 的向量检索
  - 以图搜图
  - 智能推荐
- **内容识别**
  - NSFW 检测
  - 内容分类

#### 4. 分享系统

- 短链接生成
- 分享权限控制
- 分享统计
- 分享管理

#### 5. 搜索系统

- 关键词搜索
- 标签筛选
- 分类筛选
- 高级搜索
- AI 向量搜索

#### 6. 管理后台

- **用户管理**：用户列表、权限管理
- **文件管理**：全局文件查看、审核
- **内容审核**：待审核内容管理
- **标签管理**：全局标签管理
- **分类管理**：分类体系管理
- **AI 管理**：AI 服务配置
- **向量管理**：向量数据库管理
- **系统设置**：系统配置、存储配置
- **统计分析**：数据统计、图表展示

#### 7. 增强特性

- 图片优化（压缩、格式转换）
- 水印功能
- 存储时长控制
- 自动清理
- WebSocket 实时通信
- 性能监控
- 健康检查

---

## 桌面端核心优势

### 为什么需要桌面端？

桌面端相比 Web 端具有以下天然优势：

| 维度         | Web 端             | 桌面端                         |
| ------------ | ------------------ | ------------------------------ |
| **访问速度** | 依赖浏览器启动     | 秒开，托盘常驻                 |
| **系统集成** | 无法集成           | 全局快捷键、右键菜单、文件关联 |
| **后台运行** | 关闭标签页即停止   | 托盘常驻，后台运行             |
| **剪贴板**   | 手动粘贴           | 自动监听识别                   |
| **截图**     | 需要浏览器插件     | 系统级截图工具                 |
| **拖拽上传** | 仅限浏览器窗口     | 系统任意位置拖拽               |
| **批量操作** | 受浏览器限制       | 无限制，支持文件夹递归         |
| **离线能力** | 完全依赖网络       | 离线队列、本地缓存             |
| **通知**     | 浏览器通知（受限） | 系统原生通知                   |
| **性能**     | 受浏览器沙箱限制   | 原生性能，无限制               |

---

## 差异化功能设计

### 1. 快速上传能力 ⚡

#### 截图即传

- **全局快捷键截图**：`Ctrl/Cmd + Shift + S`
- **截图工具集成**
  - 全屏截图
  - 区域截图
  - 窗口截图
  - 延时截图（3s/5s/10s）
- **标注功能**
  - 矩形/圆形标注
  - 箭头指示
  - 文字标注
  - 马赛克/模糊
- **截图后操作**
  - 自动上传
  - 手动确认
  - 本地保存 + 上传

#### 剪贴板监听

- **智能识别**
  - 自动检测剪贴板图片
  - 支持文件路径识别
- **行为配置**
  - 自动上传
  - 询问上传
  - 静默模式
- **应用黑名单**
  - 排除特定应用的剪贴板
  - 排除特定文件类型

#### 拖拽上传增强

- **系统级拖拽**
  - 拖拽到悬浮球
  - 拖拽到主窗口
  - 拖拽到托盘图标
- **智能识别**
  - 自动识别图片文件
  - 支持文件夹递归
  - 支持混合拖拽（文件+文件夹）
- **批量处理**
  - 并发上传控制
  - 失败自动重试
  - 断点续传

#### 右键菜单集成（高级）

- **文件管理器右键菜单**
  - 选中文件 → 右键 → "上传到 PixelPunk"
  - Windows：注册表集成
  - macOS：Finder 扩展

#### 批量上传

- **文件夹上传**
  - 保持文件夹结构
  - 递归扫描子文件夹
  - 自动创建对应文件夹
- **智能去重**
  - MD5 校验
  - 重复文件跳过或覆盖
- **并发控制**
  - 可配置并发数（1-10）
  - 智能队列管理
  - 带宽限制

### 2. 系统级集成 🔗

#### 托盘常驻

- **托盘图标**
  - 静态图标
  - 上传时动画效果
  - 进度显示（可选）
- **右键菜单**
  ```
  PixelPunk
  ├── 📸 截图上传
  ├── 📋 剪贴板上传
  ├── 📁 选择文件上传
  ├── ─────────────
  ├── 🕐 最近上传
  │   ├── image1.png
  │   ├── image2.jpg
  │   └── 查看更多...
  ├── ─────────────
  ├── ⚙️ 设置
  ├── 🏠 打开主窗口
  └── 🚪 退出
  ```
- **点击行为**
  - 单击：打开主窗口
  - 双击：快速上传
  - 右键：菜单

#### 全局快捷键

- **预设快捷键**
  - `Ctrl/Cmd + Shift + U`：打开上传窗口
  - `Ctrl/Cmd + Shift + S`：截图上传
  - `Ctrl/Cmd + Shift + V`：剪贴板上传
  - `Ctrl/Cmd + Shift + H`：查看历史
  - `Ctrl/Cmd + Shift + C`：复制最后上传的链接
- **自定义快捷键**
  - 用户可自定义所有快捷键
  - 冲突检测
  - 导入/导出快捷键配置

#### 系统通知

- **原生通知**
  - 上传开始通知
  - 上传进度通知（可选）
  - 上传成功通知
  - 上传失败通知
- **通知交互**
  - 点击通知：打开文件详情
  - 通知中快速复制链接
  - 通知中快速分享

#### 开机自启

- **后台常驻**
  - 开机自动启动（可配置）
  - 启动后最小化到托盘
  - 静默启动模式
- **资源占用优化**
  - 空闲时最小化资源占用
  - 智能休眠机制

### 3. 智能处理 🤖

#### 自动压缩/优化

- **上传前处理**
  - 自动压缩（可配置压缩质量）
  - 格式转换（PNG → WebP/AVIF）
  - 尺寸限制（超过自动缩放）
- **智能优化**
  - 根据文件类型选择最优压缩算法
  - 保留必要的 EXIF 信息
  - 批量处理队列

#### 智能重命名

- **命名规则**
  - 时间戳：`20251005_143022.png`
  - MD5：`a1b2c3d4e5f6.png`
  - 内容识别：`cat_portrait.png`（需 AI）
  - 自定义模板：`{date}_{name}.{ext}`
- **批量重命名**
  - 序号命名：`image_001.png`, `image_002.png`
  - 前缀/后缀添加
  - 正则替换

#### 批量水印

- **水印模板**
  - 预设多个水印模板
  - 文字水印
  - 图片水印
  - 位置、透明度、大小配置
- **批量应用**
  - 上传时自动添加水印
  - 批量后处理已上传文件

#### 格式转换

- **支持格式**
  - 输入：PNG, JPG, GIF, BMP, TIFF, WebP, AVIF
  - 输出：PNG, JPG, WebP, AVIF
- **转换选项**
  - 质量控制
  - 尺寸调整
  - 批量转换

#### EXIF 清理

- **隐私保护**
  - 自动清除 GPS 位置信息
  - 清除设备信息
  - 清除拍摄时间（可选）
- **选择性保留**
  - 保留版权信息
  - 保留作者信息
  - 自定义保留字段

### 4. 离线与缓存 💾

#### 离线队列

- **智能队列**
  - 网络断开时自动缓存
  - 网络恢复后自动上传
  - 队列持久化（本地存储）
- **队列管理**
  - 查看队列状态
  - 手动重试
  - 清空队列

#### 本地数据库

- **SQLite 数据库**
  - 文件记录缓存
  - 标签缓存
  - 文件夹结构缓存
  - 上传历史记录
- **数据同步**
  - 定期与服务器同步
  - 增量同步
  - 冲突解决

#### 历史记录

- **本地历史**
  - 最近 1000 条上传记录
  - 快速搜索（本地）
  - 标签筛选
  - 时间范围筛选
- **快速操作**
  - 快速复制链接
  - 重新上传
  - 打开原文件位置
  - 在浏览器中查看

#### 智能预加载

- **常用数据预加载**
  - 常用文件夹列表
  - 常用标签列表
  - 最近使用的分类
- **缓存策略**
  - LRU 缓存淘汰
  - 定期清理过期缓存
  - 缓存大小限制

### 5. 增强的工作流 🔄

#### 快速分享

- **上传成功后自动操作**
  - 自动复制链接到剪贴板
  - 系统通知显示链接
  - 可配置自动操作
- **多种链接格式**
  - 直链：`https://pixelpunk.com/f/abc123`
  - Markdown：`![image](https://pixelpunk.com/f/abc123)`
  - HTML：`<img src="https://pixelpunk.com/f/abc123" />`
  - BBCode：`[img]https://pixelpunk.com/f/abc123[/img]`
  - 自定义格式模板
- **批量复制**
  - 选中多个文件批量复制链接
  - 多种格式同时复制（JSON/CSV）

#### 历史搜索

- **本地快速搜索**
  - 文件名搜索
  - 标签搜索
  - 时间范围搜索
  - 文件类型筛选
- **搜索结果**
  - 缩略图预览
  - 快速操作
  - 导出搜索结果

#### 模板上传

- **预设模板**
  - 模板包含：文件夹、标签、权限、优化设置、水印
  - 可创建多个模板
  - 快速切换模板
- **场景化模板**
  - 工作文档模板（private, 高质量）
  - 社交分享模板（public, 压缩, 水印）
  - 临时文件模板（public, 7天, 压缩）

#### 批量操作

- **批量修改**
  - 批量修改标签
  - 批量移动文件夹
  - 批量更改访问权限
  - 批量修改存储时长
- **批量下载**
  - 选中文件批量下载
  - 保持文件夹结构
  - 压缩包下载
- **批量删除**
  - 选中批量删除
  - 回收站功能
  - 永久删除确认

---

## 技术实现方案

### 技术栈

#### 前端

- **框架**：Vue 3 + TypeScript
- **路由**：Vue Router 4
- **状态管理**：Pinia
- **UI 组件**：复用 Web 端组件库（赛博朋克风格）
- **样式**：TailwindCSS

#### 桌面端

- **框架**：Tauri 2
- **语言**：Rust
- **插件**
  - `@tauri-apps/plugin-fs`：文件系统
  - `@tauri-apps/plugin-http`：网络请求
  - `@tauri-apps/plugin-global-shortcut`：全局快捷键
  - `@tauri-apps/plugin-notification`：系统通知
  - `@tauri-apps/plugin-dialog`：文件对话框
  - `@tauri-apps/plugin-clipboard`：剪贴板（待集成）
  - `@tauri-apps/plugin-sql`：SQLite（待集成）

### 关键技术实现

#### 1. 截图功能

```rust
// Rust 端实现
// macOS: screencapture 命令或 CGWindowListCreateImage API
// Windows: BitBlt API 或 Windows.Graphics.Capture
// Linux: gnome-screenshot 或 scrot

#[tauri::command]
async fn capture_screenshot(mode: String) -> Result<String, String> {
    // mode: "fullscreen" | "region" | "window"
    // 返回截图文件路径或 base64
}
```

#### 2. 剪贴板监听

```rust
// 定时轮询剪贴板内容
#[tauri::command]
async fn get_clipboard_image() -> Result<Option<Vec<u8>>, String> {
    // 检测剪贴板是否有图片
    // 返回图片数据
}
```

```typescript
// 前端定时检查
setInterval(async () => {
  if (settings.clipboardMonitoring) {
    const image = await invoke("get_clipboard_image");
    if (image && isNewImage(image)) {
      // 询问或自动上传
    }
  }
}, 1000);
```

#### 3. 全局快捷键

```typescript
import { register } from "@tauri-apps/plugin-global-shortcut";

await register("CmdOrCtrl+Shift+S", async () => {
  // 触发截图上传
  await captureAndUpload();
});
```

#### 4. 拖拽上传

```typescript
import { getCurrentWebviewWindow } from "@tauri-apps/api/webviewWindow";

const window = getCurrentWebviewWindow();

window.onDragDropEvent((event) => {
  if (event.type === "drop") {
    const files = event.paths;
    handleFilesUpload(files);
  }
});
```

#### 5. 本地数据库

```typescript
import Database from "@tauri-apps/plugin-sql";

const db = await Database.load("sqlite:pixelpunk.db");

// 创建表
await db.execute(`
  CREATE TABLE IF NOT EXISTS upload_history (
    id INTEGER PRIMARY KEY,
    file_id TEXT,
    file_name TEXT,
    url TEXT,
    tags TEXT,
    uploaded_at DATETIME
  )
`);

// 插入记录
await db.execute(
  "INSERT INTO upload_history (file_id, file_name, url, tags, uploaded_at) VALUES (?, ?, ?, ?, ?)",
  [fileId, fileName, url, JSON.stringify(tags), new Date()],
);
```

#### 6. 系统托盘增强

```rust
// 动态更新托盘菜单
use tauri::menu::{Menu, MenuItem};

pub fn update_tray_menu(app: &AppHandle) -> Result<(), Error> {
    let recent_files = get_recent_uploads(5);

    let mut menu_items = vec![
        MenuItem::new("截图上传", true, Some("screenshot")),
        MenuItem::new("剪贴板上传", true, Some("clipboard")),
        // ... 动态添加最近上传的文件
    ];

    let menu = Menu::with_items(app, &menu_items)?;
    // 更新托盘菜单
}
```

### API 复用

桌面端直接复用后端 API，主要接口包括：

#### 文件相关

- `POST /api/v1/files/upload` - 文件上传
- `POST /api/v1/files/chunked/init` - 分块上传初始化
- `GET /api/v1/files` - 文件列表
- `GET /api/v1/files/:id` - 文件详情
- `PUT /api/v1/files/:id` - 更新文件信息
- `DELETE /api/v1/files/:id` - 删除文件
- `POST /api/v1/files/batch` - 批量操作

#### 文件夹相关

- `GET /api/v1/folders` - 文件夹列表
- `POST /api/v1/folders` - 创建文件夹
- `GET /api/v1/folders/:id` - 文件夹详情
- `PUT /api/v1/folders/:id` - 更新文件夹
- `DELETE /api/v1/folders/:id` - 删除文件夹

#### 标签相关

- `GET /api/v1/tags` - 标签列表
- `POST /api/v1/tags` - 创建标签
- `PUT /api/v1/tags/:id` - 更新标签
- `DELETE /api/v1/tags/:id` - 删除标签

#### 分享相关

- `GET /api/v1/shares` - 分享列表
- `POST /api/v1/shares` - 创建分享
- `GET /api/v1/shares/:key` - 分享详情
- `DELETE /api/v1/shares/:key` - 删除分享

#### 搜索相关

- `GET /api/v1/search/files` - 文件搜索
- `POST /api/v1/search/vector` - 向量搜索

#### 用户相关

- `GET /api/v1/user/profile` - 用户信息
- `GET /api/v1/user/stats` - 用户统计
- `PUT /api/v1/user/profile` - 更新用户信息

---

## 开发路线图

### 第一期：MVP（最小可行产品）

**目标**：完成核心上传功能，让桌面端可用

- ✅ 基础架构（已完成）
- ✅ 登录系统对接（已完成）
- [ ] 菜单系统设计与实现
- [ ] 快速上传功能
  - [ ] 拖拽上传
  - [ ] 选择文件上传
  - [ ] 文件夹上传
  - [ ] 上传进度显示
  - [ ] 上传队列管理
- [ ] 截图上传
  - [ ] 全局快捷键截图
  - [ ] 区域截图
  - [ ] 自动上传
- [ ] 剪贴板上传
  - [ ] 剪贴板监听
  - [ ] 自动/询问上传
- [ ] 文件管理（基础）
  - [ ] 文件列表展示
  - [ ] 文件详情查看
  - [ ] 文件删除
  - [ ] 文件搜索
- [ ] 快速分享
  - [ ] 上传后自动复制链接
  - [ ] 多种链接格式
- [ ] 基础设置
  - [ ] 快捷键配置
  - [ ] 上传默认配置
  - [ ] 通知设置

**预计完成时间**：2-3 周

### 第二期：增强功能

**目标**：完善工具箱，提升用户体验

- [ ] 工具箱
  - [ ] 图片压缩工具
  - [ ] 格式转换工具
  - [ ] 水印工具
  - [ ] EXIF 清理工具
- [ ] 批量操作
  - [ ] 批量上传
  - [ ] 批量修改标签
  - [ ] 批量移动文件夹
  - [ ] 批量下载
  - [ ] 批量删除
- [ ] 离线队列
  - [ ] 网络异常时缓存
  - [ ] 自动重试机制
  - [ ] 队列管理界面
- [ ] 历史记录
  - [ ] 本地数据库缓存
  - [ ] 快速搜索
  - [ ] 历史记录管理
- [ ] 通知增强
  - [ ] 详细的上传进度通知
  - [ ] 通知交互（点击操作）
  - [ ] 通知中心
- [ ] 文件夹管理
  - [ ] 文件夹树形展示
  - [ ] 文件夹操作（创建/重命名/删除）
  - [ ] 拖拽移动文件
- [ ] 标签管理
  - [ ] 标签列表
  - [ ] 标签编辑
  - [ ] 标签筛选

**预计完成时间**：3-4 周

### 第三期：高级功能

**目标**：集成 AI 功能，打造专业工具

- [ ] AI 功能集成
  - [ ] 智能标签识别
  - [ ] 向量搜索
  - [ ] 以图搜图
  - [ ] 内容识别（NSFW）
- [ ] 高级编辑
  - [ ] 截图标注工具
  - [ ] 内置图片编辑器
  - [ ] 批量编辑
- [ ] 数据统计
  - [ ] 本地统计分析
  - [ ] 图表展示
  - [ ] 导出报表
- [ ] 多账号支持
  - [ ] 账号切换
  - [ ] 多账号同步
  - [ ] 账号管理
- [ ] 分享管理
  - [ ] 分享列表
  - [ ] 分享统计
  - [ ] 分享权限管理
- [ ] 管理中心（管理员）
  - [ ] 用户管理
  - [ ] 文件审核
  - [ ] 系统监控

**预计完成时间**：4-5 周

### 第四期：体验优化

**目标**：优化性能，提升体验

- [ ] 性能优化
  - [ ] 虚拟滚动
  - [ ] 懒加载
  - [ ] 缓存优化
  - [ ] 内存优化
- [ ] 体验优化
  - [ ] 动画效果
  - [ ] 快捷键优化
  - [ ] 主题切换
  - [ ] 多语言支持
- [ ] 高级特性
  - [ ] 插件系统
  - [ ] 自定义脚本
  - [ ] Webhook 集成
  - [ ] 第三方存储集成

**预计完成时间**：2-3 周

---

## 总结

桌面端的核心价值在于：

1. **速度快**：秒开、托盘常驻、本地缓存
2. **体验好**：系统级集成、全局快捷键、原生通知
3. **能力强**：截图、剪贴板、批量操作、离线队列
4. **效率高**：一键上传、快速分享、模板上传

通过充分利用桌面端的技术优势，打造一个比 Web 端更强大、更便捷的图床客户端。
